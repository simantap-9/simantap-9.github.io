import React, { useState, useEffect, useMemo, useRef } from 'react';

// --- DATABASE REFERENSI BARANG (SSH) ---
const REFERENCE_DB_RAW = [
    "Kertas HVS",
    "Kertas Manila",
    "Kertas Karton",
    "Kertas Gambar",
    "Kertas Foto",
    "Pulpen",
    "Pensil",
    "Spidol",
    "Stabilo/Highlighter",
    "Penghapus Pensil",
    "Tipe-X/Penghapus Cair",
    "Cutter/Pisau Pemotong",
    "Gunting",
    "Lem Kertas",
    "Selotip/Plester",
    "Lakban",
    "Map Folder",
    "Stopmap",
    "Perforator",
    "Stapler",
    "Isi Stapler",
    "Penjepit Kertas",
    "Binder Clip",
    "Tinta Printer",
    "Toner Printer",
    "Buku Tulis Siswa",
    "Buku Agenda",
    "Buku Kas",
    "Sapu Ijuk",
    "Pel Lantai",
    "Ember",
    "Cairan Pembersih Lantai",
    "Sabun Cuci Tangan",
    "Bola Lampu",
    "Baterai",
    "Kabel Rol",
    "Masker",
    "Hand Sanitizer",
    "Tisu",
    "Tempat Sampah",
    "Karbol/Desinfektan",
    "Mouse Komputer"
];

// --- COMPONENTS & ICONS ---
const Icon = ({ name, size = 20, className }) => {
    const icons = {
        home: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>,
        box: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>,
        in: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 5v14M5 12h14"/></svg>,
        out: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/></svg>,
        settings: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
        fileText: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>,
        trash: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
        printer: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>,
        download: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
        edit: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
        alert: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>,
        trending: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>,
        arrowLeft: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>,
        camera: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>,
        menu: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>,
        x: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    };
    return icons[name] || null;
};

// --- SUB COMPONENTS ---

const NavButton = ({ active, onClick, icon, label }) => (
    <button 
        onClick={onClick}
        className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 border-l-4 text-sm md:text-base ${
            active 
            ? 'bg-slate-100 border-slate-600 text-slate-900 font-bold shadow-sm' 
            : 'border-transparent text-slate-400 hover:bg-slate-700 hover:text-slate-100'
        }`}
    >
        <Icon name={icon} className={active ? 'text-slate-900' : 'text-slate-400'} />
        {label}
    </button>
);

const Input = ({ label, type = "text", ...props }) => (
    <div>
        <label className="block mb-1 text-sm font-medium text-slate-600">{label}</label>
        <input 
            type={type} 
            className="w-full border border-gray-300 rounded p-2 focus:ring-2 focus:ring-slate-500 focus:outline-none transition-shadow bg-white text-slate-800"
            {...props}
        />
    </div>
);

// --- PREVIEW & PDF COMPONENT ---
const PreviewMode = ({ data, config, onBack }) => {
    const [loading, setLoading] = useState(false);

    const handleDownloadPDF = () => {
        const element = document.getElementById('printable-area');
        if (!element || !window.html2pdf) {
            alert("Sistem PDF belum siap. Tunggu sebentar atau refresh halaman.");
            return;
        }

        setLoading(true);
        // Clean filename from special characters
        const safeId = (data.nomorBukti || data.id).toString().replace(/[^a-zA-Z0-9]/g, '_');
        const opt = {
            margin:       0.5,
            filename:     `Bukti_${data.type === 'in' ? 'Masuk' : 'Keluar'}_${safeId}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true },
            jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        window.html2pdf().set(opt).from(element).save().then(() => {
            setLoading(false);
        });
    };

    return (
        <div className="space-y-6 animate-fade-in pb-10 w-full">
            {/* Toolbar - Hidden when printing */}
            <div className="no-print bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col md:flex-row justify-between items-center sticky top-0 z-20 gap-3">
                <button onClick={onBack} className="flex items-center gap-2 text-slate-600 hover:text-slate-900 w-full md:w-auto justify-center md:justify-start">
                    <Icon name="arrowLeft" /> Kembali
                </button>
                <div className="flex gap-3 w-full md:w-auto">
                    <button 
                        onClick={() => window.print()} 
                        className="flex-1 md:flex-none flex justify-center items-center gap-2 bg-slate-100 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-200 transition font-bold text-sm md:text-base"
                    >
                        <Icon name="printer" /> Cetak
                    </button>
                    <button 
                        onClick={handleDownloadPDF} 
                        disabled={loading}
                        className={`flex-1 md:flex-none flex justify-center items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition font-bold shadow text-sm md:text-base ${loading ? 'opacity-50 cursor-not-allowed' : ''}`}
                    >
                        {loading ? 'Proses...' : <><Icon name="download" /> PDF</>}
                    </button>
                </div>
            </div>

            {/* Printable Area Container with Scroll for Mobile */}
            <div className="flex justify-center w-full overflow-x-auto">
                <div 
                    id="printable-area" 
                    className="bg-white p-6 md:p-10 shadow-2xl min-w-[21cm] max-w-[21cm] min-h-[29.7cm] text-black font-serif relative"
                    style={{ border: '1px solid #e5e7eb' }}
                >
                    {/* Header / KOP */}
                    <div className="text-center border-b-4 border-double border-black pb-4 mb-6">
                        <h2 className="text-xl font-bold uppercase">{config.pemda}</h2>
                        <h1 className="text-3xl font-bold uppercase">{config.sekolah}</h1>
                        <p className="text-sm italic">{config.alamat}</p>
                    </div>

                    <div className="text-center mb-8">
                        <h3 className="text-xl font-bold underline uppercase mb-2">
                            BUKTI {data.type === 'in' ? 'PENERIMAAN' : 'PENGAMBILAN'} BARANG
                        </h3>
                        {/* MENAMPILKAN NOMOR TRANSAKSI RESMI */}
                        <p className="font-bold text-lg">Nomor: {data.nomorBukti || `(Draft) #${data.id}`}</p>
                    </div>

                    <div className="mb-6 flex justify-between items-start">
                        <table className="w-2/3 text-left">
                            <tbody>
                                <tr>
                                    <td className="w-32 md:w-48 font-bold align-top">Tanggal</td>
                                    <td className="align-top">: {data.tanggal}</td>
                                </tr>
                                <tr>
                                    <td className="font-bold align-top">{data.type === 'in' ? 'Sumber' : 'Tujuan'}</td>
                                    <td className="align-top">: {data.type === 'in' ? data.rekanan : data.unitKerja}</td>
                                </tr>
                            </tbody>
                        </table>
                        {/* FOTO DI SURAT JALAN */}
                        {data.image && (
                            <div className="w-1/3 flex justify-end">
                                <div className="border border-gray-300 p-1">
                                    <img src={data.image} alt="Bukti Barang" className="h-20 md:h-24 w-auto object-cover" />
                                </div>
                            </div>
                        )}
                    </div>

                    <table className="w-full border-collapse border border-black mb-12">
                        <thead>
                            <tr className="bg-gray-200">
                                <th className="border border-black p-2 text-center w-10 md:w-16">No</th>
                                <th className="border border-black p-2">Nama Barang</th>
                                <th className="border border-black p-2 text-center w-24 md:w-32">Satuan</th>
                                <th className="border border-black p-2 text-center w-20 md:w-32">Jumlah</th>
                                <th className="border border-black p-2">Ket</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td className="border border-black p-4 text-center">1</td>
                                <td className="border border-black p-4 font-bold">
                                    {data.namaBarang}
                                </td>
                                <td className="border border-black p-4 text-center">{data.satuan}</td>
                                <td className="border border-black p-4 text-center font-bold text-lg">{data.jumlah}</td>
                                <td className="border border-black p-4">{data.keterangan}</td>
                            </tr>
                        </tbody>
                    </table>

                    {/* Tanda Tangan */}
                    <div className="flex justify-between mt-16 px-4 break-inside-avoid text-sm md:text-base">
                        {/* KIRI */}
                        <div className="text-center w-5/12">
                            {data.type === 'in' ? (
                                <>
                                    <p>Mengetahui,</p>
                                    <p>Atasan Langsung</p>
                                    <div className="h-20 md:h-24"></div>
                                    <p className="font-bold underline">{config.atasan}</p>
                                    <p>NIP. {config.nipAtasan}</p>
                                </>
                            ) : (
                                <>
                                    <p>&nbsp;</p>
                                    <p>Yang Mengambil</p>
                                    <div className="h-20 md:h-24"></div>
                                    <p className="font-bold underline">{data.unitKerja}</p>
                                    <p>(Unit Kerja)</p>
                                </>
                            )}
                        </div>

                        {/* KANAN */}
                        <div className="text-center w-5/12">
                            <p>Mataram, {data.tanggal}</p>
                            <p>{data.type === 'in' ? 'Penyimpan Barang' : 'Yang Menyerahkan'}</p>
                            <div className="h-20 md:h-24"></div>
                            <p className="font-bold underline">{config.penyimpan}</p>
                            <p>NIP. {config.nipPenyimpan}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- DASHBOARD HOME COMPONENT ---
const DashboardHome = ({ stats, recentTransactions, onNavigate, config }) => {
    return (
        <div className="space-y-6 animate-fade-in">
            {/* HERO SECTION */}
            <div className="bg-gradient-to-r from-slate-600 to-slate-500 rounded-xl p-6 text-white shadow-lg">
                <h2 className="text-xl md:text-2xl font-bold mb-1">Selamat Datang di SIMANTAP-9</h2>
                <p className="opacity-90 text-xs md:text-sm">Sistem Manajemen Persediaan Terpadu - {config.sekolah}</p>
                <div className="mt-4 flex flex-col md:flex-row gap-3">
                    <button onClick={() => onNavigate('in')} className="bg-white text-slate-700 text-xs font-bold px-4 py-3 md:py-2 rounded shadow hover:bg-slate-100 transition text-center">
                        + Input Penerimaan
                    </button>
                    <button onClick={() => onNavigate('out')} className="bg-slate-700 border border-slate-500 text-white text-xs font-bold px-4 py-3 md:py-2 rounded shadow hover:bg-slate-800 transition text-center">
                        - Input Pengeluaran
                    </button>
                </div>
            </div>

            {/* STATS GRID */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <StatCard title="Jenis Barang" value={stats.totalItems} icon="box" color="bg-white border-slate-200" textColor="text-slate-700" />
                <StatCard title="Barang Masuk" value={stats.inTx} icon="in" color="bg-white border-slate-200" textColor="text-green-600" />
                <StatCard title="Barang Keluar" value={stats.outTx} icon="out" color="bg-white border-slate-200" textColor="text-red-600" />
                <StatCard title="Stok Menipis" value={stats.lowStock} icon="alert" color={stats.lowStock > 0 ? "bg-red-50 border-red-200" : "bg-white border-slate-200"} textColor={stats.lowStock > 0 ? "text-red-600" : "text-slate-400"} />
            </div>

            {/* RECENT ACTIVITY */}
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                    <h3 className="font-bold text-slate-700 flex items-center gap-2">
                        <Icon name="trending" size={16} /> Aktivitas Terbaru
                    </h3>
                    <button onClick={() => onNavigate('report')} className="text-xs text-slate-500 hover:text-slate-800 hover:underline">
                        Lihat Semua &rarr;
                    </button>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left text-slate-600">
                        <thead className="text-xs text-slate-400 uppercase bg-white border-b border-slate-100">
                            <tr>
                                <th className="px-4 py-3 whitespace-nowrap">No.Bukti</th>
                                <th className="px-4 py-3">Tgl</th>
                                <th className="px-4 py-3">Tipe</th>
                                <th className="px-4 py-3 min-w-[150px]">Barang</th>
                                <th className="px-4 py-3 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {recentTransactions.length === 0 ? (
                                <tr>
                                    <td colSpan="5" className="px-4 py-8 text-center text-slate-400 italic">
                                        Belum ada aktivitas.
                                    </td>
                                </tr>
                            ) : (
                                recentTransactions.map((tx) => (
                                    <tr key={tx.id} className="border-b border-slate-50 hover:bg-slate-50 transition">
                                        <td className="px-4 py-3 text-xs font-mono">{tx.nomorBukti ? tx.nomorBukti.split('/')[0] : '-'}..</td>
                                        <td className="px-4 py-3 whitespace-nowrap text-xs">{tx.tanggal}</td>
                                        <td className="px-4 py-3">
                                            <span className={`px-2 py-1 rounded text-[10px] md:text-xs font-bold ${tx.type === 'in' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                {tx.type === 'in' ? 'MASUK' : 'KELUAR'}
                                            </span>
                                        </td>
                                        <td className="px-4 py-3 font-medium text-slate-800">
                                            <div className="flex items-center gap-2">
                                                {tx.image && <img src={tx.image} className="w-6 h-6 rounded object-cover border bg-slate-100" />}
                                                <div className="truncate max-w-[120px] md:max-w-none">
                                                    {tx.namaBarang} <span className="text-slate-400 text-xs">({tx.jumlah})</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td className="px-4 py-3 text-right">
                                            <span className="text-xs text-slate-400 italic truncate max-w-[80px] block text-right">{tx.keterangan || '-'}</span>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
};

const StatCard = ({ title, value, icon, color, textColor }) => (
    <div className={`p-4 rounded-xl border shadow-sm ${color} flex items-center justify-between`}>
        <div>
            <p className="text-xs text-slate-400 uppercase font-semibold">{title}</p>
            <p className={`text-2xl font-bold mt-1 ${textColor}`}>{value}</p>
        </div>
        <div className={`p-3 rounded-full bg-slate-50 ${textColor}`}>
            <Icon name={icon} size={24} />
        </div>
    </div>
);

const SetupForm = ({ config, setConfig }) => {
    const handleChange = (e) => {
        setConfig({ ...config, [e.target.name]: e.target.value });
    };

    return (
        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 max-w-4xl mx-auto">
            <h3 className="text-lg font-bold mb-6 border-b border-slate-100 pb-2 text-slate-700 flex items-center gap-2">
                <Icon name="settings" className="text-slate-400"/> Setup User & Institusi
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <Input label="Pemda" name="pemda" value={config.pemda} onChange={handleChange} />
                <Input label="Nama Sekolah" name="sekolah" value={config.sekolah} onChange={handleChange} />
                <div className="md:col-span-2">
                    <Input label="Alamat Sekolah" name="alamat" value={config.alamat} onChange={handleChange} />
                </div>
                <Input label="Nama Penyimpan Barang" name="penyimpan" value={config.penyimpan} onChange={handleChange} />
                <Input label="NIP Penyimpan" name="nipPenyimpan" value={config.nipPenyimpan} onChange={handleChange} />
                <Input label="Nama Atasan Langsung" name="atasan" value={config.atasan} onChange={handleChange} />
                <Input label="NIP Atasan" name="nipAtasan" value={config.nipAtasan} onChange={handleChange} />
                <Input label="Bulan Pengadaan" name="bulanPengadaan" value={config.bulanPengadaan} onChange={handleChange} placeholder="Contoh: November 2025" />
                <Input label="Tanggal Laporan Default" type="date" name="tanggalLapor" value={config.tanggalLapor} onChange={handleChange} />
            </div>
            <div className="mt-6 bg-slate-50 text-slate-600 p-3 rounded text-sm border border-slate-200">
                Perubahan disimpan secara otomatis ke memori browser.
            </div>
        </div>
    );
};

// --- UPDATED TRANSACTION FORM ---
const TransactionForm = ({ type, onSubmit, onUpdate, history, onDelete, onPrint, existingItems, stockData }) => {
    const isInput = type === 'in';
    const [editId, setEditId] = useState(null);
    const fileInputRef = useRef(null);

    const [form, setForm] = useState({
        tanggal: new Date().toISOString().split('T')[0],
        rekanan: '', 
        unitKerja: '', 
        namaBarang: '',
        satuan: 'Pcs',
        jumlah: '',
        keterangan: '-',
        image: null // Base64 string
    });

    const handleEditClick = (tx) => {
        setEditId(tx.id);
        setForm({
            tanggal: tx.tanggal,
            rekanan: tx.rekanan || '',
            unitKerja: tx.unitKerja || '',
            namaBarang: tx.namaBarang,
            satuan: tx.satuan,
            jumlah: tx.jumlah,
            keterangan: tx.keterangan || '-',
            image: tx.image || null
        });
    };

    const handleCancelEdit = () => {
        setEditId(null);
        setForm({
            tanggal: new Date().toISOString().split('T')[0],
            rekanan: '',
            unitKerja: '',
            namaBarang: '',
            satuan: 'Pcs',
            jumlah: '',
            keterangan: '-',
            image: null
        });
        if(fileInputRef.current) fileInputRef.current.value = "";
    };

    const handleNameChange = (e) => {
        const val = e.target.value;
        const matchedItem = existingItems.find(item => item.name === val);
        
        // If Outgoing, try to inherit image from stock if exists
        let inheritedImage = form.image;
        if (!isInput && !inheritedImage && matchedItem) {
             // Find latest IN transaction for this item to get image
             const itemInStock = stockData.find(s => s.name === val);
             if (itemInStock && itemInStock.image) {
                 inheritedImage = itemInStock.image;
             }
        }

        setForm(prev => ({
            ...prev,
            namaBarang: val,
            satuan: matchedItem ? matchedItem.unit : prev.satuan,
            image: inheritedImage || prev.image
        }));
    };

    // --- IMAGE PROCESSING (RESIZE) ---
    const handleImageUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                // Resize logic: Max width 300px (to save localStorage space)
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 300;
                const scaleSize = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scaleSize;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                // Convert to compressed Base64
                const dataUrl = canvas.toDataURL('image/jpeg', 0.7); 
                setForm(prev => ({ ...prev, image: dataUrl }));
            }
            img.src = event.target.result;
        }
        reader.readAsDataURL(file);
    };

    const currentStock = React.useMemo(() => {
        if (!form.namaBarang) return null;
        const item = stockData.find(s => s.name === form.namaBarang);
        return item ? item.current : 0;
    }, [form.namaBarang, stockData]);

    const handleSubmit = (e) => {
        e.preventDefault();
        
        if (!isInput && !editId) {
            if (currentStock === null || currentStock < parseInt(form.jumlah)) {
                if(!confirm(`Stok untuk "${form.namaBarang}" hanya tersisa ${currentStock || 0}. Yakin ingin tetap melanjutkan? (Stok akan minus)`)) {
                    return;
                }
            }
        }

        if (editId) {
            onUpdate(editId, form);
            handleCancelEdit();
        } else {
            onSubmit(type, form);
            setForm(prev => ({ ...prev, namaBarang: '', jumlah: '', keterangan: '-', image: null })); 
            if(fileInputRef.current) fileInputRef.current.value = "";
        }
    };

    return (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="lg:col-span-1">
                <form onSubmit={handleSubmit} className={`p-4 md:p-6 rounded-xl shadow-sm border ${editId ? 'bg-yellow-50 border-yellow-400' : 'bg-white border-slate-200'} sticky top-6`}>
                    <h3 className="text-lg font-bold mb-4 border-b border-slate-100 pb-2 text-slate-700 flex items-center justify-between">
                        <span className="flex items-center gap-2">
                            <Icon name={isInput ? 'in' : 'out'} className={isInput ? 'text-green-600' : 'text-red-600'} />
                            {editId ? 'Ubah' : (isInput ? 'Input Masuk' : 'Input Keluar')}
                        </span>
                        {editId && (
                            <span className="text-[10px] bg-yellow-200 text-yellow-800 px-2 py-1 rounded">Edit Mode</span>
                        )}
                    </h3>
                    
                    <div className="space-y-4">
                        <Input label="Tanggal" type="date" value={form.tanggal} onChange={(e) => setForm({...form, tanggal: e.target.value})} required />
                        
                        {isInput ? (
                            <Input label="Toko / Rekanan" value={form.rekanan} onChange={(e) => setForm({...form, rekanan: e.target.value})} placeholder="Nama Toko" required />
                        ) : (
                            <Input label="Unit Kerja Penerima" value={form.unitKerja} onChange={(e) => setForm({...form, unitKerja: e.target.value})} placeholder="Misal: TU, Perpus, Guru" required />
                        )}

                        <datalist id="itemOptions">
                            {existingItems.map((item, idx) => (
                                <option key={idx} value={item.name} />
                            ))}
                        </datalist>

                        <div>
                            <label className="block mb-1 text-sm font-medium text-slate-600">Nama Barang</label>
                            <input 
                                type="text" 
                                list="itemOptions" 
                                className="w-full border border-gray-300 rounded p-2 focus:ring-2 focus:ring-slate-500 focus:outline-none transition-shadow bg-white text-slate-800"
                                value={form.namaBarang} 
                                onChange={handleNameChange} 
                                placeholder="Ketik atau pilih dari daftar..." 
                                required 
                                autoComplete="off"
                            />
                            {!isInput && form.namaBarang && (
                                <p className={`text-xs mt-1 ${currentStock > 0 ? 'text-green-600' : 'text-red-600'}`}>
                                    Sisa Stok: <strong>{currentStock || 0}</strong> {form.satuan}
                                </p>
                            )}
                        </div>
                        
                        <div className="grid grid-cols-2 gap-2">
                            <Input label="Jumlah" type="number" value={form.jumlah} onChange={(e) => setForm({...form, jumlah: e.target.value})} required />
                            <div>
                                <label className="block mb-1 text-sm font-medium text-slate-600">Satuan</label>
                                <select 
                                    className="w-full border border-gray-300 rounded p-2 focus:ring-2 focus:ring-slate-500 focus:outline-none text-slate-700 bg-white"
                                    value={form.satuan}
                                    onChange={(e) => setForm({...form, satuan: e.target.value})}
                                >
                                    <option>Pcs</option>
                                    <option>Rim</option>
                                    <option>Box</option>
                                    <option>Unit</option>
                                    <option>Botol</option>
                                    <option>Pack</option>
                                    <option>Buah</option>
                                    <option>Lembar</option>
                                    <option>Dus</option>
                                    <option>Kotak</option>
                                    <option>Batang</option>
                                    <option>Rol</option>
                                    <option>Set</option>
                                    <option>Buku</option>
                                    <option>Meter</option>
                                    <option>Lusin</option>
                                    <option>Block</option>
                                    <option>Eks</option>
                                    <option>Kaleng</option>
                                </select>
                            </div>
                        </div>

                        {/* INPUT FOTO */}
                        {isInput && (
                            <div>
                                <label className="block mb-1 text-sm font-medium text-slate-600 flex items-center gap-2">
                                    <Icon name="camera" size={14}/> Foto Barang (Opsional)
                                </label>
                                <input 
                                    type="file" 
                                    accept="image/*"
                                    ref={fileInputRef}
                                    onChange={handleImageUpload}
                                    className="block w-full text-sm text-slate-500
                                      file:mr-4 file:py-2 file:px-4
                                      file:rounded-full file:border-0
                                      file:text-xs file:font-semibold
                                      file:bg-slate-50 file:text-slate-700
                                      hover:file:bg-slate-100"
                                />
                                <p className="text-[10px] text-slate-400 mt-1">*Otomatis dikompres agar ringan.</p>
                            </div>
                        )}
                        
                        {/* PREVIEW IMAGE IN FORM */}
                        {form.image && (
                            <div className="relative w-full h-32 bg-slate-100 rounded overflow-hidden border">
                                <img src={form.image} alt="Preview" className="w-full h-full object-contain" />
                                {isInput && (
                                    <button 
                                        type="button"
                                        onClick={() => { setForm(p => ({...p, image: null})); if(fileInputRef.current) fileInputRef.current.value=""; }}
                                        className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 shadow"
                                    >
                                        <Icon name="trash" size={12}/>
                                    </button>
                                )}
                            </div>
                        )}

                        <Input label="Keterangan" value={form.keterangan} onChange={(e) => setForm({...form, keterangan: e.target.value})} />
                        
                        <div className="flex gap-2">
                            <button type="submit" className={`flex-1 text-white font-bold py-3 px-4 rounded hover:opacity-90 transition shadow-sm ${editId ? 'bg-yellow-600' : (isInput ? 'bg-green-600' : 'bg-red-600')}`}>
                                {editId ? 'UPDATE' : 'SIMPAN'}
                            </button>
                            {editId && (
                                <button type="button" onClick={handleCancelEdit} className="bg-slate-500 text-white font-bold py-3 px-4 rounded hover:bg-slate-600 transition shadow-sm">
                                    BATAL
                                </button>
                            )}
                        </div>
                    </div>
                </form>
            </div>

            <div className="lg:col-span-2">
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                        <h3 className="font-bold text-slate-700">Riwayat {isInput ? 'Penerimaan' : 'Pengeluaran'} Terkini</h3>
                        <span className="text-xs text-slate-500 bg-slate-200 px-2 py-1 rounded">{history.length} Data</span>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left text-slate-600">
                            <thead className="text-xs text-slate-500 uppercase bg-slate-100">
                                <tr>
                                    <th className="px-4 py-3 whitespace-nowrap">No.Bukti</th>
                                    <th className="px-4 py-3">Tgl</th>
                                    <th className="px-4 py-3 min-w-[120px]">{isInput ? 'Toko' : 'Unit'}</th>
                                    <th className="px-4 py-3 min-w-[150px]">Barang</th>
                                    <th className="px-4 py-3">Foto</th>
                                    <th className="px-4 py-3">Jml</th>
                                    <th className="px-4 py-3 text-right">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                {history.length === 0 ? (
                                    <tr>
                                        <td colSpan="7" className="px-4 py-8 text-center text-slate-400">Belum ada data.</td>
                                    </tr>
                                ) : (
                                    history.map((tx) => (
                                        <tr key={tx.id} className={`border-b border-slate-50 hover:bg-slate-50 ${editId === tx.id ? 'bg-yellow-50' : 'bg-white'}`}>
                                            <td className="px-4 py-3 text-xs font-mono whitespace-nowrap">{tx.nomorBukti ? tx.nomorBukti.split('/')[0] : '-'}..</td>
                                            <td className="px-4 py-3 whitespace-nowrap">{tx.tanggal}</td>
                                            <td className="px-4 py-3">{isInput ? tx.rekanan : tx.unitKerja}</td>
                                            <td className="px-4 py-3 font-medium text-slate-800">{tx.namaBarang}</td>
                                            <td className="px-4 py-3">
                                                {tx.image ? (
                                                    <img src={tx.image} alt="img" className="w-8 h-8 md:w-10 md:h-10 object-cover rounded border" />
                                                ) : <span className="text-xs text-slate-300">-</span>}
                                            </td>
                                            <td className="px-4 py-3 whitespace-nowrap">{tx.jumlah} {tx.satuan}</td>
                                            <td className="px-4 py-3 text-right space-x-1 whitespace-nowrap">
                                                <button onClick={() => onPrint(tx)} className="text-blue-600 hover:text-blue-800 p-1" title="Cetak Bukti">
                                                    <Icon name="printer" size={16} />
                                                </button>
                                                <button onClick={() => handleEditClick(tx)} className="text-yellow-600 hover:text-yellow-800 p-1" title="Ubah Data">
                                                    <Icon name="edit" size={16} />
                                                </button>
                                                <button onClick={() => onDelete(tx.id)} className="text-red-600 hover:text-red-800 p-1" title="Hapus">
                                                    <Icon name="trash" size={16} />
                                                </button>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- MAIN APP COMPONENT ---
export default function App() {
    const [activeTab, setActiveTab] = useState('home');
    const [isSidebarOpen, setSidebarOpen] = useState(false);
    const [previousTab, setPreviousTab] = useState('home');
    
    // Inject html2pdf script
    useEffect(() => {
        const script = document.createElement('script');
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js";
        script.async = true;
        document.body.appendChild(script);
        return () => {
            document.body.removeChild(script);
        }
    }, []);

    // Initial Data
    const initialConfig = {
        pemda: "Provinsi Nusa Tenggara Barat",
        sekolah: "SMAN 9 Mataram",
        alamat: "Jl. Pejanggik 28 Mataram",
        penyimpan: "Hj. Siti Aminah",
        nipPenyimpan: "19800101 200501 2 001",
        atasan: "Drs. H. Lalu Budi",
        nipAtasan: "19750505 199903 1 005",
        bulanPengadaan: "November 2025",
        tanggalLapor: new Date().toISOString().split('T')[0]
    };

    const [config, setConfig] = useState(() => {
        try {
            const saved = localStorage.getItem('simantap_config');
            return saved ? JSON.parse(saved) : initialConfig;
        } catch (e) {
            return initialConfig;
        }
    });

    const [transactions, setTransactions] = useState(() => {
        try {
            const saved = localStorage.getItem('simantap_transactions');
            return saved ? JSON.parse(saved) : [];
        } catch (e) {
            return [];
        }
    });

    const [printData, setPrintData] = useState(null);

    useEffect(() => {
        localStorage.setItem('simantap_config', JSON.stringify(config));
    }, [config]);

    useEffect(() => {
        localStorage.setItem('simantap_transactions', JSON.stringify(transactions));
    }, [transactions]);

    const handleAddTransaction = (type, data) => {
        const dateObj = new Date(data.tanggal);
        const month = dateObj.getMonth();
        const year = dateObj.getFullYear();
        
        const countInMonth = transactions.filter(t => {
            const tDate = new Date(t.tanggal);
            return tDate.getMonth() === month && tDate.getFullYear() === year;
        }).length;

        const sequence = String(countInMonth + 1).padStart(3, '0');
        const romans = ["I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X", "XI", "XII"];
        const monthRoman = romans[month];
        const nomorBukti = `${sequence}/SARPRAS/SMAN9/${monthRoman}/${year}`;

        const newTx = {
            id: Date.now(),
            nomorBukti,
            type, 
            ...data
        };
        setTransactions([newTx, ...transactions]);
        setActiveTab('report');
    };

    const handleUpdateTransaction = (id, updatedData) => {
        setTransactions(transactions.map(t => 
            t.id === id ? { ...t, ...updatedData } : t
        ));
    };

    const handleDelete = (id) => {
        if(window.confirm('Yakin ingin menghapus data ini?')) {
            setTransactions(transactions.filter(t => t.id !== id));
        }
    };

    const handlePrint = (tx) => {
        let txToPrint = { ...tx };
        if (!txToPrint.image && txToPrint.type === 'out') {
             const stockItem = inventoryReport.find(s => s.name === tx.namaBarang);
             if (stockItem && stockItem.image) {
                 txToPrint.image = stockItem.image;
             }
        }
        setPrintData(txToPrint);
        setPreviousTab(activeTab);
        setActiveTab('preview');
    };

    const exportToCSV = () => {
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "ID,No.Bukti,Tanggal,Tipe,Sumber/Tujuan,Nama Barang,Satuan,Jumlah,Keterangan\n";
        
        transactions.forEach(row => {
            const dest = row.type === 'in' ? row.rekanan : row.unitKerja;
            csvContent += `${row.id},${row.nomorBukti || '-'},${row.tanggal},${row.type === 'in' ? 'MASUK' : 'KELUAR'},${dest},${row.namaBarang},${row.satuan},${row.jumlah},${row.keterangan}\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "simantap_data_log.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    const inventoryReport = useMemo(() => {
        const stock = {};
        transactions.forEach(tx => {
            if (!stock[tx.namaBarang]) {
                stock[tx.namaBarang] = { 
                    name: tx.namaBarang, 
                    unit: tx.satuan, 
                    in: 0, 
                    out: 0, 
                    current: 0,
                    image: null
                };
            }
            const qty = parseInt(tx.jumlah) || 0;
            if (tx.type === 'in') {
                stock[tx.namaBarang].in += qty;
                if(tx.image) stock[tx.namaBarang].image = tx.image;
            } else {
                stock[tx.namaBarang].out += qty;
            }
            
            stock[tx.namaBarang].current = stock[tx.namaBarang].in - stock[tx.namaBarang].out;
        });
        return Object.values(stock);
    }, [transactions]);

    const uniqueItems = useMemo(() => {
        const items = new Map();
        REFERENCE_DB_RAW.forEach(rawName => {
            let unit = 'Pcs';
            const lower = rawName.toLowerCase();
            if (lower.includes('rim')) unit = 'Rim';
            else if (lower.includes('lembar')) unit = 'Lembar';
            else if (lower.includes('batang')) unit = 'Batang';
            else if (lower.includes('botol')) unit = 'Botol';
            else if (lower.includes('rol')) unit = 'Rol';
            else if (lower.includes('set')) unit = 'Set';
            else if (lower.includes('buku')) unit = 'Buku';
            else if (lower.includes('kotak')) unit = 'Kotak';
            else if (lower.includes('pak')) unit = 'Pack';
            else if (lower.includes('lusin')) unit = 'Lusin';
            else if (lower.includes('kaleng')) unit = 'Kaleng';
            else if (lower.includes('meter')) unit = 'Meter';
            
            items.set(rawName, { unit });
        });
        transactions.forEach(tx => {
            items.set(tx.namaBarang, { unit: tx.satuan });
        });
        return Array.from(items).map(([name, val]) => ({ name, unit: val.unit }));
    }, [transactions]);

    const dashboardStats = useMemo(() => {
        return {
            totalItems: inventoryReport.length,
            inTx: transactions.filter(t => t.type === 'in').length,
            outTx: transactions.filter(t => t.type === 'out').length,
            lowStock: inventoryReport.filter(i => i.current <= 5).length
        };
    }, [inventoryReport, transactions]);

    return (
        <div className="min-h-screen flex flex-col font-sans bg-slate-50 text-slate-900">
            {/* INJECT PRINT STYLES */}
            <style>{`
                @media print {
                    .no-print { display: none !important; }
                    body { background-color: white; }
                    #printable-area { 
                        width: 100% !important; 
                        box-shadow: none !important; 
                        margin: 0 !important;
                        border: none !important;
                    }
                    aside { display: none !important; }
                }
                ::-webkit-scrollbar { width: 4px; height: 4px; }
                ::-webkit-scrollbar-track { background: #f1f5f9; }
                ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
                ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
            `}</style>

            <div className="flex flex-1 h-screen overflow-hidden">
                {/* MOBILE OVERLAY */}
                {isSidebarOpen && (
                    <div 
                        className="fixed inset-0 bg-black/50 z-20 md:hidden"
                        onClick={() => setSidebarOpen(false)}
                    />
                )}

                {/* SIDEBAR RESPONSIVE */}
                {activeTab !== 'preview' && (
                    <aside className={`
                        fixed inset-y-0 left-0 z-30 w-64 bg-slate-800 text-white flex flex-col shadow-2xl transition-transform duration-300 ease-in-out no-print
                        ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}
                        md:relative md:translate-x-0
                    `}>
                        <div className="p-6 border-b border-slate-700 bg-slate-900 flex justify-between items-center">
                            <div>
                                <h1 className="text-xl md:text-2xl font-bold text-white tracking-tighter">SIMANTAP-9</h1>
                                <p className="text-[10px] md:text-xs text-slate-400 mt-1">SMAN 9 Mataram</p>
                            </div>
                            <button onClick={() => setSidebarOpen(false)} className="md:hidden text-slate-400 hover:text-white">
                                <Icon name="x" />
                            </button>
                        </div>
                        <nav className="flex-1 p-4 space-y-2 overflow-y-auto bg-slate-800">
                            <div className="text-xs font-bold text-slate-500 uppercase px-4 py-2 mt-2">Menu Utama</div>
                            <NavButton active={activeTab==='home'} onClick={()=>{setActiveTab('home'); setSidebarOpen(false);}} icon="home" label="Beranda" />
                            <NavButton active={activeTab==='report'} onClick={()=>{setActiveTab('report'); setSidebarOpen(false);}} icon="fileText" label="Laporan Data" />
                            
                            <div className="text-xs font-bold text-slate-500 uppercase px-4 py-2 mt-6">Transaksi</div>
                            <NavButton active={activeTab==='in'} onClick={()=>{setActiveTab('in'); setSidebarOpen(false);}} icon="in" label="Barang Masuk" />
                            <NavButton active={activeTab==='out'} onClick={()=>{setActiveTab('out'); setSidebarOpen(false);}} icon="out" label="Barang Keluar" />
                            
                            <div className="text-xs font-bold text-slate-500 uppercase px-4 py-2 mt-6">Sistem</div>
                            <NavButton active={activeTab==='setup'} onClick={()=>{setActiveTab('setup'); setSidebarOpen(false);}} icon="settings" label="Pengaturan" />
                        </nav>
                        <div className="p-4 text-xs text-slate-500 text-center border-t border-slate-700 bg-slate-900">
                            &copy; 2025 SMAN 9 Mataram
                        </div>
                    </aside>
                )}

                {/* CONTENT AREA */}
                <main className={`flex-1 overflow-y-auto flex flex-col ${activeTab === 'preview' ? 'bg-slate-200' : 'bg-slate-50'}`}>
                    {activeTab !== 'preview' && (
                        <header className="bg-white shadow-sm border-b border-slate-200 p-4 md:p-6 flex justify-between items-center sticky top-0 z-10 no-print">
                            <div className="flex items-center gap-3">
                                {/* HAMBURGER BUTTON */}
                                <button 
                                    onClick={() => setSidebarOpen(true)}
                                    className="md:hidden p-2 text-slate-600 hover:bg-slate-100 rounded-lg"
                                >
                                    <Icon name="menu" />
                                </button>
                                <div>
                                    <h2 className="text-lg md:text-2xl font-bold text-slate-800">
                                        {activeTab === 'home' && 'Dashboard'}
                                        {activeTab === 'report' && 'Laporan & Stok'}
                                        {activeTab === 'in' && 'Penerimaan'}
                                        {activeTab === 'out' && 'Pengeluaran'}
                                        {activeTab === 'setup' && 'Pengaturan'}
                                    </h2>
                                    <p className="text-[10px] md:text-sm text-slate-500 hidden md:block">Periode: {config.bulanPengadaan}</p>
                                </div>
                            </div>
                            <div className="text-right text-xs md:text-sm border-l border-slate-200 pl-4">
                                <p className="font-bold text-slate-700 truncate max-w-[100px] md:max-w-none">{config.penyimpan}</p>
                                <p className="text-slate-500 text-[10px] md:text-xs">NIP. {config.nipPenyimpan}</p>
                            </div>
                        </header>
                    )}

                    <div className={`${activeTab === 'preview' ? 'p-4 md:p-8 flex justify-center' : 'p-4 md:p-6 max-w-7xl mx-auto pb-20 w-full'}`}>
                        {activeTab === 'home' && (
                            <DashboardHome 
                                stats={dashboardStats} 
                                recentTransactions={transactions.slice(0, 5)} 
                                onNavigate={setActiveTab}
                                config={config}
                            />
                        )}

                        {activeTab === 'setup' && (
                            <SetupForm config={config} setConfig={setConfig} />
                        )}

                        {activeTab === 'in' && (
                            <TransactionForm 
                                type="in" 
                                onSubmit={handleAddTransaction} 
                                onUpdate={handleUpdateTransaction}
                                history={transactions.filter(t => t.type === 'in')} 
                                onDelete={handleDelete}
                                onPrint={handlePrint}
                                existingItems={uniqueItems}
                                stockData={inventoryReport}
                            />
                        )}

                        {activeTab === 'out' && (
                            <TransactionForm 
                                type="out" 
                                onSubmit={handleAddTransaction} 
                                onUpdate={handleUpdateTransaction}
                                history={transactions.filter(t => t.type === 'out')} 
                                onDelete={handleDelete}
                                onPrint={handlePrint}
                                existingItems={uniqueItems}
                                stockData={inventoryReport}
                            />
                        )}

                        {activeTab === 'preview' && printData && (
                            <div className="w-full">
                                <PreviewMode 
                                    data={printData} 
                                    config={config} 
                                    onBack={() => setActiveTab(previousTab)}
                                />
                            </div>
                        )}

                        {activeTab === 'report' && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="flex justify-end">
                                    <button 
                                        onClick={exportToCSV}
                                        className="flex items-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded shadow hover:bg-emerald-700 transition text-sm md:text-base"
                                    >
                                        <Icon name="download" /> Download Excel
                                    </button>
                                </div>

                                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                    <div className="p-4 border-b border-slate-200 bg-slate-50">
                                        <h3 className="font-bold text-slate-700">Tabel Stok Barang</h3>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm text-left text-slate-600">
                                            <thead className="text-xs text-slate-500 uppercase bg-slate-100">
                                                <tr>
                                                    <th className="px-6 py-3 min-w-[200px]">Nama Barang</th>
                                                    <th className="px-6 py-3">Foto</th>
                                                    <th className="px-6 py-3">Satuan</th>
                                                    <th className="px-6 py-3 text-center text-blue-600 whitespace-nowrap">Total Masuk</th>
                                                    <th className="px-6 py-3 text-center text-red-600 whitespace-nowrap">Total Keluar</th>
                                                    <th className="px-6 py-3 text-center font-bold text-slate-800 bg-yellow-50 whitespace-nowrap">Stok Saat Ini</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {inventoryReport.length === 0 ? (
                                                    <tr>
                                                        <td colSpan="6" className="px-6 py-12 text-center text-slate-400">
                                                            Belum ada data transaksi. Silahkan input penerimaan.
                                                        </td>
                                                    </tr>
                                                ) : (
                                                    inventoryReport.map((item, idx) => (
                                                        <tr key={idx} className="bg-white border-b border-slate-100 hover:bg-slate-50 transition">
                                                            <td className="px-6 py-4 font-medium text-slate-900">{item.name}</td>
                                                            <td className="px-6 py-4">
                                                                {item.image ? (
                                                                    <img src={item.image} alt="stok" className="w-10 h-10 object-cover rounded border" />
                                                                ) : <span className="text-xs text-slate-300">-</span>}
                                                            </td>
                                                            <td className="px-6 py-4">{item.unit}</td>
                                                            <td className="px-6 py-4 text-center">{item.in}</td>
                                                            <td className="px-6 py-4 text-center">{item.out}</td>
                                                            <td className={`px-6 py-4 text-center font-bold ${item.current <= 5 ? 'text-red-600 bg-red-50' : 'text-slate-800 bg-yellow-50'}`}>
                                                                {item.current}
                                                            </td>
                                                        </tr>
                                                    ))
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </main>
            </div>
        </div>
    );
}